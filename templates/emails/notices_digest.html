<!doctype html>
<html>
  <body style="margin:0;padding:0;background:#f6f7fb;font-family:Arial,Helvetica,sans-serif;color:#111;">
    <div style="background:linear-gradient(90deg,#7a193d,#9c3757);color:#fff;padding:16px 12px;">
      <div style="max-width:600px;margin:0 auto;font-weight:bold;">Eduvos Parent Portal</div>
    </div>
    <div style="max-width:600px;margin:16px auto;background:#fff;border:1px solid #e5e7eb;border-radius:12px;overflow:hidden;">
      <div style="padding:16px 16px 0 16px;">
        <h2 style="margin:0 0 4px 0;font-size:18px;">Weekly digest</h2>
        <p style="margin:0;color:#6b7280;">
          {{ subject_vars.students }} student(s) · {{ subject_vars.total }} notices ·
          {{ subject_vars.attendance_flags }} attendance alert(s)
        </p>
      </div>

      {% for student in students %}
      <div style="padding:16px;border-top:1px solid #f0f2f5;">
        <h3 style="margin:0 0 8px 0;font-size:16px;">{{ student.name }}</h3>

        <div style="margin-bottom:12px;">
          <div style="font-weight:bold;margin-bottom:4px;">Transcript highlights</div>
          {% if student.transcript.has_data %}
            {% for module in student.transcript.modules %}
            <div style="padding:8px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:6px;">
              <div style="font-weight:600;">{{ module.module }} ({{ module.code }})</div>
              <div style="font-size:12px;color:#6b7280;">
                Result: {{ module.result }} · Score: {{ module.percentage|default:"-" }}
              </div>
            </div>
            {% endfor %}
          {% else %}
            <div style="color:#9ca3af;font-size:13px;">No published grades this week.</div>
          {% endif %}
        </div>

        <div style="margin-bottom:12px;">
          <div style="font-weight:bold;margin-bottom:4px;">At-risk alerts</div>
          {% if student.atrisk.has_data %}
            <ul style="padding-left:18px;margin:0;color:#374151;font-size:13px;">
              {% for item in student.atrisk.items %}
              <li>
                {{ item.module_code }} — {{ item.primary_reason }}
                {% if item.secondary_reason %} ({{ item.secondary_reason }}){% endif %}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="color:#9ca3af;font-size:13px;">No at-risk items reported.</div>
          {% endif %}
        </div>

        <div style="margin-bottom:12px;">
          <div style="font-weight:bold;margin-bottom:4px;">Attendance</div>
          <div style="font-size:13px;color:#374151;">
            Total sessions: {{ student.attendance.total }} · Alerts: {{ student.attendance.alerts }}
          </div>
          {% if student.attendance.flagged %}
            <ul style="padding-left:18px;margin:4px 0 0 0;color:#374151;font-size:13px;">
              {% for flag in student.attendance.flagged %}
              <li>{{ flag.date }} — {{ flag.module }} ({{ flag.status }})</li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="color:#9ca3af;font-size:13px;">No attendance issues.</div>
          {% endif %}
        </div>

        <div style="margin-bottom:12px;">
          <div style="font-weight:bold;margin-bottom:4px;">Financial status</div>
          {% if student.financial.label %}
            <div style="font-size:13px;color:#374151;">{{ student.financial.label }}</div>
          {% else %}
            <div style="color:#9ca3af;font-size:13px;">No financial data available.</div>
          {% endif %}
        </div>

        <div>
          <div style="font-weight:bold;margin-bottom:4px;">Documents</div>
          {% if student.documents.has_data %}
            <ul style="padding-left:18px;margin:0;color:#374151;font-size:13px;">
              {% for doc in student.documents.items %}
              <li>
                {{ doc.title }} {% if doc.student_specific %}<span style="color:#7a193d;">(student)</span>{% endif %}
              </li>
              {% endfor %}
            </ul>
          {% else %}
            <div style="color:#9ca3af;font-size:13px;">No new documents.</div>
          {% endif %}
        </div>
      </div>
      {% empty %}
      <div style="padding:16px;border-top:1px solid #f0f2f5;color:#9ca3af;font-size:13px;">
        No linked students yet. Add a student in the portal to receive weekly updates.
      </div>
      {% endfor %}

      <div style="padding:16px;border-top:1px solid #f0f2f5;">
        <h3 style="margin:0 0 8px 0;font-size:16px;">Announcements</h3>
        {% if notices_counts.total %}
          {% for bucket, entries in notices.items %}
          {% if entries %}
          <div style="margin-bottom:12px;">
            <div style="font-weight:bold;text-transform:capitalize;">{{ bucket }} ({{ notices_counts|get_item:bucket }})</div>
            {% for ann in entries %}
            <div style="padding:10px;border:1px solid #e5e7eb;border-radius:8px;margin-top:6px;">
              <div style="font-weight:600;">{{ ann.title }}</div>
              <div style="font-size:12px;color:#6b7280;">{{ ann.published_at }}</div>
              <div style="margin-top:6px;">
                <a href="{{ site_url }}{% url 'content:announcement_detail' ann.id %}" style="color:#7a193d;text-decoration:none;">View announcement</a>
              </div>
            </div>
            {% endfor %}
          </div>
          {% endif %}
          {% endfor %}
        {% else %}
          <div style="color:#9ca3af;font-size:13px;">No new announcements this week.</div>
        {% endif %}
      </div>

      <div style="padding:16px;border-top:1px solid #f0f2f5;color:#6b7280;font-size:12px;">
        <div>If you no longer wish to receive these, you can <a href="{{ unsubscribe_url }}" style="color:#7a193d;">unsubscribe here</a>.</div>
      </div>
    </div>
  </body>
</html>
